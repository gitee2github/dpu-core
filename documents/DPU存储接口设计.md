# DPU应用层存储接口设计

1. [存储设备接口Payload描述](#payload)
    1. [基于Go语言的定义](#payload_go)
1. [存储设备接口动作](#apis)
    1. [List](#apis_list)
    2. [Get](#apis_get)
    3. [Create](#apis_create)
    4. [Update](#apis_update)
    5. [Delete](#apis_delete)


--------

## 存储设备接口Payload描述 <a name="payload"></a>
--------

### 基于Go语言的定义（待完善） <a name="payload_go"></a>
--------


```go
import (
	"time"
)

type BlockDeviceType string

const (
	BlockDeviceTypeVirtioBLK  BlockDeviceType = "Virtio-BLK"
	BlockDeviceTypeVirtioSCSI BlockDeviceType = "Virtio-SCSI"
	BlockDeviceTypeVirtioNVMe BlockDeviceType = "NVMe"
)

type BlockDevice struct {
	ObjectMeta   `json:"metadata,omitempty" protobuf:"bytes,1,opt,name=metadata"`
	DeviceType   BlockDeviceType `json:"deviceType"`
	DeviceSource `json:",inline"`
	Options      *BlockDeviceOption `json:"options,omitempty"`
	Info         *BlockDeviceInfo   `json:"info,omitempty"`
}

type ObjectMeta struct {
	// Name must be unique within a namespace. Is required when creating resources, although
	// some resources may allow a client to request the generation of an appropriate name
	// automatically. Name is primarily intended for creation idempotence and configuration
	// definition.
	// Cannot be updated.
	// More info: http://kubernetes.io/docs/user-guide/identifiers#names
	// +optional
	Name string `json:"name,omitempty"`

	// UID is the unique in time and space value for this object. It is typically generated by
	// the server on successful creation of a resource and is not allowed to change on PUT
	// operations.
	//
	// Populated by the system.
	// Read-only.
	// More info: http://kubernetes.io/docs/user-guide/identifiers#uids
	// +optional
	UID string `json:"uid,omitempty"`

	// An opaque value that represents the internal version of this object that can
	// be used by clients to determine when objects have changed. May be used for optimistic
	// concurrency, change detection, and the watch operation on a resource or set of resources.
	// Clients must treat these values as opaque and passed unmodified back to the server.
	// They may only be valid for a particular resource or set of resources.
	//
	// Populated by the system.
	// Read-only.
	// Value must be treated as opaque by clients and .
	// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#concurrency-control-and-consistency
	// +optional
	ResourceVersion int64 `json:"resourceVersion,omitempty"`

	// A sequence number representing a specific generation of the desired state.
	// Populated by the system. Read-only.
	// +optional
	Generation int64 `json:"generation,omitempty"`

	// CreationTimestamp is a timestamp representing the server time when this object was
	// created. It is not guaranteed to be set in happens-before order across separate operations.
	// Clients may not set this value. It is represented in RFC3339 form and is in UTC.
	//
	// Populated by the system.
	// Read-only.
	// Null for lists.
	// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata
	// +optional
	CreationTimestamp time.Time `json:"creationTimestamp,omitempty"`
}

type DeviceSource struct {
	ISCSI  *ISCSIDeviceSource  `json:"iscsi,omitempty"`
	RBD    *RBDDeviceSource    `json:"rbd,omitempty"`
	NVMf   *NVMfDeviceSource   `json:"nvmf,omitempty"`
	Memory *MemoryDeviceSource `json:"memory,omitempty"`
}

type ISCSIDeviceSource struct {
	TargetPortal      string                   `json:"targetPortal"`
	IQN               string                   `json:"iqn"`
	Lun               int32                    `json:"lun"`
	ISCSIInterface    string                   `json:"iscsiInterface,omitempty"`
	Portals           []string                 `json:"portals,omitempty"`
	DiscoveryCHAPAuth bool                     `json:"chapAuthDiscovery,omitempty"`
	SessionCHAPAuth   bool                     `json:"chapAuthSession,omitempty"`
	Secret            string                   `json:"secret,omitempty"`
	InitiatorName     *string                  `json:"initiatorName,omitempty"`
	Options           *ISCSIDeviceSourceOption `json:"options,omitempty"`
}

type RBDDeviceSource struct {
	RBDImage  string                 `json:"image"`
	RBDPool   string                 `json:"pool,omitempty"`
	RadosUser string                 `json:"user,omitempty"`
	Keyring   string                 `json:"keyring,omitempty"`
	Options   *RBDDeviceSourceOption `json:"options,omitempty"`
}

type NVMfDeviceSource struct {
	// NVMe-oF target trtype: rdma or tcp
	TransportType string `json:"transportType"`
	//NVMe-oF target address: ip
	TransportAddr string `json:"transportAddr"`
	// NVMe-oF target adrfam: ipv4, ipv6, ib, fc, intra_host
	TransportAddrFamily string `json:"transportAddrFamily"`
	// NVMe-oF target trsvcid: port number
	TransportServiceID int32 `json:"transportServiceID,omitempty"`
	// NVMe-oF target subnqn
	NQN string `json:"nqn"`
	// NVMe-oF host subnqn
	HostNQN string                  `json:"hostnqn,omitempty"`
	Options *NVMfDeviceSourceOption `json:"options,omitempty"`
}

type MemoryDeviceSource struct {
	// Size in MB
	Size int64 `json:"size"`
}

type BlockDeviceOption struct {
	// Block size
	BlockSize int32 `json:"blockSize,omitempty"`
	ReadOnly  bool  `json:"readOnly,omitempty"`
}

type ISCSIDeviceSourceOption struct {
	// TODO: iSCSI有哪些参数可以配置？
}

type RBDDeviceSourceOption struct {
	// TODO: RBD有哪些参数可以配置？
}

type NVMfDeviceSourceOption struct {
	// TODO: NVMF配置增删
	//Enable checking of PI reference tag for I/O processing
	PrchkRefTag bool `json:"prchk_reftag,omitempty"`
	//Enable checking of PI guard for I/O processing
	PrchkGuard bool `json:"prchk_guard,omitempty"`
	//Enable TCP header digest
	Hdgst bool `json:"hdgst,omitempty"`
	//Enable TCP data digest
	Ddgst bool `json:"ddgst,omitempty"`
	//Timeout for fabrics connect (in microseconds)
	FabricsConnectTimeoutUs bool `json:"fabrics_connect_timeout_us,omitempty"`
	//The number of IO queues to request during initialization. Range: (0, UINT16_MAX + 1], Default is 1024.
	NumIoQueues uint32 `json:"num_io_queues,omitempty"`
	//Time to wait until ctrlr is reconnected before deleting ctrlr. -1 means infinite reconnects. 0 means no reconnect.
	CtrlrLossTimeoutSec int `json:"ctrlr_loss_timeout_sec,omitempty"`
	//Time to delay a reconnect trial. 0 means no reconnect.
	ReconnectDelaySec int `json:"reconnect_delay_sec,omitempty"`
	//Time to wait until ctrlr is reconnected before failing I/O to ctrlr. 0 means no such timeout.
	FastIoFailTimeoutSec int `json:"fast_io_fail_timeout_sec,omitempty"`
	//PSK in hexadecimal digits, e.g. 1234567890ABCDEF (Enables SSL socket implementation for TCP)
	Psk string `json:"psk,omitempty"`
}

type BlockDeviceInfo struct {
	// TODO: 存储设备创建完成后，需要暴露哪些信息？
	Status string `json:"status,omitempty"`
	PciBDF string `json:"pciBDF,omitempty"`
}
```



## 存储设备接口动作 <a name="apis"></a>
--------

### List  <a name="apis_list"></a>
--------

List接口返回当前所有的BlockDevice列表

当BlockDevice不支持动态创建时（比如基于VF实现），厂商需要在初始化后，返回可用的设备列表，后续由用户指定对应设备通过更新操作完成挂载步骤

### Get  <a name="apis_get"></a>
--------

返回对应设备的详细信息

### Create  <a name="apis_create"></a>
--------

当DPU支持动态创建设备时，通过Create动态创建设备

### Update  <a name="apis_update"></a>
--------

更新设备信息，需要指定设备，通常应该是PATCH接口，有部分字段创建后不允许修改，更新时需要同步提供ResourceVersion，避免并发更新导致的问题

### Delete  <a name="apis_delete"></a>
--------

删除设备
